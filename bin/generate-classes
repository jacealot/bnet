#!/usr/bin/env php
<?php

declare(strict_types=1);

/*
 * This file is part of the Battle.net API Client package.
 *
 * (c) Jonas Stendahl <jonas@stendahl.me>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

set_error_handler(static function ($severity, $message, $file, $line): void {
    if ($severity & error_reporting()) {
        throw new ErrorException($message, 0, $severity, $file, $line);
    }
});

chdir(dirname(__DIR__));

require_once 'vendor/autoload.php';

if (false === file_exists('resources/metadata.json')) {
    fwrite(STDERR, 'Unable to load API metadata');
    exit(1);
}

$metadata = json_decode(file_get_contents('resources/metadata.json'));
$loader = new Twig_Loader_Filesystem('resources/templates');
$twig = new Twig_Environment($loader, [
    'strict_variables' => true,
]);

$twig->addExtension(new class() extends Twig_Extension {
    public function getFilters(): array
    {
        return [
            new Twig_Filter('ucwords', 'ucwords'),
        ];
    }
});

foreach ($metadata as $namespace => $apis) {
    $baseDir = 'src/Apis/'.$namespace;
    $baseTestDir = 'tests/Apis/'.$namespace;

    if (false === file_exists($baseDir) && false === @mkdir($baseDir) && false === is_dir($baseDir)) {
        fwrite(STDERR, '"'.$baseDir.'" is not a valid directory');
        exit(1);
    }

    if (false === file_exists($baseTestDir) && false === @mkdir($baseTestDir) && false === is_dir($baseTestDir)) {
        fwrite(STDERR, '"'.$baseTestDir.'" is not a valid directory');
        exit(1);
    }

    foreach ($apis as $className => $data) {
        $endpoints = [];
        $hasUnavailable = false;

        foreach ($data->endpoints as $endpoint) {
            $arguments = [];
            $argumentValues = [];
            $pathArgs = [];
            $queryArgs = [];

            foreach ($endpoint->parameters as $parameter) {
                if ('query' === $parameter->kind && in_array($parameter->name, ['callback', 'jsonp', 'locale'], true)) {
                    continue;
                }

                $name = str_replace(['{', '}', ':'], '', $parameter->name);

                if ('pathReplace' === $parameter->kind) {
                    $endpoint->url = str_replace(
                        $parameter->name,
                        '\'.$'.$name.'.\'',
                        $endpoint->url
                    );

                    if (null !== $endpoint->overrides) {
                        foreach ($endpoint->overrides as $key => $value) {
                            $endpoint->overrides[$key]['url'] = str_replace(
                                $parameter->name,
                                '\'.$'.$name.'.\'',
                                $endpoint->overrides[$key]['url']
                            );
                        }
                    }

                    $pathArgs[] = [
                        'name' => $name,
                        'type' => str_replace(['integer', 'number'], 'int', $parameter->type),
                        'value' => $parameter->value,
                    ];
                } elseif ('query' === $parameter->kind) {
                    $queryArgs[] = [
                        'name' => $name,
                        'type' => str_replace(['integer', 'number'], 'int', $parameter->type),
                        'value' => $parameter->value,
                    ];
                }
            }

            if (false === $hasUnavailable && count($endpoint->unavailable) > 0) {
                $hasUnavailable = true;
            }

            $arguments = array_merge($pathArgs, $queryArgs);
            $endpoints[] = [
                'method' => $endpoint->name,
                'url' => str_replace('.\'\'', '', '\''.$endpoint->url.'\''),
                'arguments' => implode(', ', array_map(static function (array $argument): string {
                    return $argument['type'].' $'.$argument['name'];
                }, $arguments)),
                'argumentValues' => implode(', ', array_map(static function (array $argument): string {
                    if ('string' === $argument['type']) {
                        return '\''.$argument['value'].'\'';
                    }

                    return $argument['value'];
                }, $arguments)),
                'queryArgs' => $queryArgs,
                'verb' => '\''.$endpoint->verb.'\'',
                'overrides' => array_map(static function (stdClass $override): stdClass {
                    $override->url = str_replace('.\'\'', '', '\''.$override->url.'\'');

                    return $override;
                }, $endpoint->overrides),
                'unavailable' => $endpoint->unavailable,
            ];
        }

        file_put_contents(
            $baseDir.'/'.$className.'.php',
            $twig->render('Api.php.twig', [
                'auth' => ('key' === $data->auth) ? 'apiKey' : 'accessToken',
                'className' => $className,
                'namespace' => $namespace,
                'endpoints' => $endpoints,
                'hasUnavailable' => $hasUnavailable,
            ])
        );

        file_put_contents(
            $baseTestDir.'/'.$className.'Test.php',
            $twig->render('ApiTest.php.twig', [
                'auth' => ('key' === $data->auth) ? 'apiKey' : 'accessToken',
                'className' => $className,
                'namespace' => $namespace,
                'endpoints' => $endpoints,
                'hasUnavailable' => $hasUnavailable,
            ])
        );
    }
}
