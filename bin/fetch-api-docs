#!/usr/bin/env php
<?php

declare(strict_types=1);

/*
 * This file is part of the Battle.net API Client package.
 *
 * (c) Jonas Stendahl <jonas@stendahl.me>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

use GuzzleHttp\Client;
use GuzzleHttp\Pool;
use GuzzleHttp\Psr7\Request;
use Psr\Http\Message\RequestInterface;
use Psr\Http\Message\ResponseInterface;
use Symfony\Component\DomCrawler\Crawler;

set_error_handler(static function ($severity, $message, $file, $line): void {
    if ($severity & error_reporting()) {
        throw new ErrorException($message, 0, $severity, $file, $line);
    }
});

chdir(dirname(__DIR__));

require_once 'vendor/autoload.php';

$client = new Client();
/** @var RequestInterface[] $requests */
$requests = [];

foreach ([
    'https://develop.battle.net/assets/api/oauth-api.json',
    'https://develop.battle.net/assets/api/community-oauth-api-cn.json',
    'https://develop.battle.net/assets/api/community-api-cn.json',
    'https://develop.battle.net/assets/api/d3-community-api.json',
    'https://develop.battle.net/assets/api/d3-game-data-api.json',
    'https://develop.battle.net/assets/api/hearthstone-game-data-api.json',
    'https://develop.battle.net/assets/api/sc2-community-api.json',
    'https://develop.battle.net/assets/api/sc2-game-data-api.json',
    'https://develop.battle.net/assets/api/wow-community-api.json',
    'https://develop.battle.net/assets/api/wow-game-data-api.json',
    'https://develop.battle.net/assets/api/wow-profile-api.json',
] as $url) {
    $requests[] = new Request('GET', $url);
}

$pool = new Pool($client, $requests, [
    'fulfilled' => function (ResponseInterface $response, int $index) use ($requests) {
        file_put_contents(sprintf(
            'resources/apis/%s',
            basename((string) $requests[$index]->getUri())
        ), (string) $response->getBody());
    },
    'rejected' => function ($reason) {
        throw new RuntimeException($reason);
    },
]);

$pool->promise()->wait();
